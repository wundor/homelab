---
- set_fact:
    shutdown_service: true
  when: "shutdown_service is not defined"

- name: Remove {{ service }} stack
  docker_stack:
    name: '{{ service }}'
    state: absent
  delegate_to: "{{ groups['edge'][0] }}"
  become: true
  when: "shutdown_service|bool == true"

- set_fact:
    time: '{{ ansible_date_time.iso8601_basic_short }}'

- name: Pause for stack removal
  pause:
    seconds: 30
  when: "shutdown_service|bool == true"

- name: Create ZFS snapshots
  zfs:
    name: '{{ zfs_pool }}/{{ item.value }}@backup-{{ time }}'
    state: present
  loop: '{{ zfs | dict2items }}'
  become: true
  delegate_to: "{{ groups['nas'][0] }}"
  register: service_backup

- import_role:
    name: services
    tasks_from: uplift
  when: "shutdown_service|bool == true"

- import_role:
    name: backup
