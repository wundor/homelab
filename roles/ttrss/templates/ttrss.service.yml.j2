{{ ansible_managed | comment }}
---
version: '{{ compose_version }}'
services:
  {{ service }}:
    image: wangqiru/ttrss:{{ version }}
    environment:
      - SELF_URL_PATH=https://{{ dns.fe }}/
      - DB_PASS={{ db_pass }}
      - DB_HOST=postgres
    volumes:
      - feed_icons:/var/www/feed-icons/
    networks:
      - {{ traefik_network }}
      - default
    deploy:
      {{ placement }}
      labels:
        {{ traefik_default_labels }}

  mercury: # set Mercury Parser API endpoint to `service.mercury:3000` on TTRSS plugin setting page
    image: wangqiru/mercury-parser-api:latest
    networks:
      - default
    deploy:
      {{ placement }}

  postgres:
    image: postgres:13-alpine
    environment:
      - POSTGRES_PASSWORD={{ db_pass }}
    volumes:
      - type: volume
        source: {{ service }}_postgres
        target: /var/lib/postgresql/data
      {{ volume_nocopy }}
        source: {{ service }}_postgres_dump
        target: /dump
    networks:
      - default
    deploy:
      placement:
        constraints:
          - node.labels.scope==db

volumes:
  feed_icons:
  {{ service }}_postgres:
{% for (key,value) in zfs.items() %}
  {{ service }}_{{ key }}:
    {{ nfs_volume }}
      device: ':/{{ zfs_pool }}/{{ value }}'
{% endfor %}

networks:
  {{ traefik_network }}:
    external: true