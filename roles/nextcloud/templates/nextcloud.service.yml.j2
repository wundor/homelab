---
{{ ansible_managed | comment }}
version: '{{ compose_version }}'
services:
  redis:
    image: redis:6
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
    deploy:
      {{ placement }}

  db:
    image: mariadb:10.5
    healthcheck:
      test: ['CMD', 'mysqladmin', '-p$$MYSQL_ROOT_PASSWORD', 'ping']
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    environment:
      - MYSQL_ROOT_PASSWORD={{ db_root_pass }}
      - MYSQL_PASSWORD={{ db_pass }}
      - MYSQL_DATABASE={{ service }}
      - MYSQL_USER={{ service }}
    volumes:
      {{ volume_nocopy }}
        source: {{ service }}_db
        target: /var/lib/mysql
    deploy:
      {{ placement }}
      rollback_config:
        order: stop-first
{#
  cron:
    image: nextcloud:{{ version }}
    volumes:
      {{ volume_nocopy }}
        source: {{ service}}_app
        target: /var/www/html
      {{ volume_nocopy }}
        source: {{ service}}_data
        target: /mnt/nextcloud
    entrypoint: /cron.sh
    deploy:
      {{ placement }}
#}

  {{ service }}:
    image: nextcloud:{{ version }}
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/cron.php']
    volumes:
      {{ volume_nocopy }}
        source: my_data
        target: /mnt/files
      {{ volume_nocopy }}
        source: my_photos
        target: /mnt/photos
      {{ volume_nocopy }}
        source: my_archive
        target: /mnt/archive
      {{ volume_nocopy }}
        source: {{ service }}_app
        target: /var/www/html
      {{ volume_nocopy }}
        source: {{ service }}_data
        target: /mnt/nextcloud
    networks:
      - {{ traefik_network }}
      - default
    environment:
            # - APACHE_DISABLE_REWRITE_IP=1
            # - TRUSTED_PROXIES=172.30.0.0/16
      - REDIS_HOST=redis
      - MYSQL_PASSWORD={{ db_pass }}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=db
      - OVERWRITEHOST={{ dns.fe }}
      - OVERWRITEPROTOCOL=https
      - NEXTCLOUD_DATA_DIR=/mnt/nextcloud
    deploy:
      {{ placement }}
      labels:
        {{ traefik_default_labels }}

networks:
  {{ traefik_network }}:
    external: true

volumes:
  my_data:
    {{ nfs_volume }}
      device: ':/{{ zfs_pool }}/files'
  my_photos:
    {{ nfs_volume }}
      device: ':/{{ zfs_pool }}/photos'
  my_archive:
    {{ nfs_volume }}
      device: ':/{{ zfs_pool }}/archive'
{% for (key,value) in zfs.items() %}
  {{ service }}_{{ key }}:
    {{ nfs_volume }}
      device: ':/{{ zfs_pool }}/{{ value }}'
{% endfor %}